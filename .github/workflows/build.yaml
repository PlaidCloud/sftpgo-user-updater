name: SFTPGO User Updater Build and Deploy
on:
  push:
    branches:
      - main
jobs:
  build-io:
    name: IO Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Create tag
        id: docker_tag
        run: |
          commit_tag=${GITHUB_SHA:0:7}
          echo "tag=${commit_tag}-${{ github.run_number }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
      - name: Verify tag
        run: echo ${{ steps.docker_tag.outputs.tag }}
      - name: Login to GCR
        uses: docker/login-action@v3
        with:
          registry: us-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCR_JSON_KEY }} 
      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          push: true
          pull: true
          no-cache: true
          build-args: |
            PLAID_BUILD_TAG=${{ steps.docker_tag.outputs.tag }}
          tags: us-docker.pkg.dev/plaidcloud-build/us-plaidcloud/tenant-tools/sftpgo-user-updater:latest,us-docker.pkg.dev/plaidcloud-build/us-plaidcloud/tenant-tools/sftpgo-user-updater:${{ steps.docker_tag.outputs.tag }}
      - name: Checkout Tenant Infrastructure Repository
        uses: actions/checkout@v4
        with:
          repository: PlaidCloud/plaid-tenant-infrastructure
          ref: master
          fetch-depth: '1'
          path: infrastructure
          token: ${{ secrets.GITOPS_REPO_ACCESS }}
      - name: Update SFTPGO User Updater Image
        uses: fjogeleit/yaml-update-action@main
        with:
          repository: PlaidCloud/plaid-tenant-infrastructure
          branch: master
          message: 'Update SFTPGO User Updater Image to ${{ steps.docker_tag.outputs.tag }}'
          token: ${{ secrets.GITOPS_REPO_ACCESS }}
          workDir: infrastructure
          changes: |
            {
              "tenants/templates/optional-features/sftpgo/deployment-sftpgo-user-updater.yaml": {
                "spec.template.spec.containers[0].image": "us-docker.pkg.dev/plaidcloud-build/us-plaidcloud/tenant-tools/sftpgo-user-updater:${{ steps.docker_tag.outputs.tag }}"
              }
            }
